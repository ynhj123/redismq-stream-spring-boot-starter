# Redis Stream MQ死信功能实现计划

## 1. 核心需求分析

* 当消息多次无法消费时，将消息移至死信队列

* 支持用户通过实现接口来消费死信队列

* 兼容现有代码架构

## 2. 实现方案

### 2.1 死信队列设计

* 死信队列命名规则：`{event}-dlq`

* 重试次数阈值可配置（默认3次）

* 死信消息包含原始消息内容、失败原因、重试次数和时间戳

### 2.2 监听模式修改

* 将现有的`receiveAutoAck`改为`receive`手动ACK模式

* 实现消息消费的重试机制

* 记录消息消费失败次数

### 2.3 死信消费者设计

* 定义死信消费者接口

* 支持通过注解声明死信队列监听

* 与现有消费者实现方式保持一致

## 3. 代码修改点

### 3.1 接口层修改

* 在`RedisStreamMqStartService`中添加死信相关方法

* 支持配置重试次数和死信队列

### 3.2 实现层修改

* 修改`RedisStreamMqStartServiceImpl`：

  * 将`receiveAutoAck`改为`receive`

  * 实现重试逻辑

  * 实现死信队列逻辑

* 新增死信消息处理器

### 3.3 注解增强

* 扩展`RedisStreamMqListen`注解，添加：

  * `maxAttempts`：最大重试次数（默认3次）

  * `isDeadLetterQueue`：是否为死信队列（默认false）

### 3.4 死信消费者接口

* 定义`DeadLetterStreamListener`接口，继承自`StreamListener`

* 支持用户通过实现该接口来消费死信队列

### 3.5 自动配置

* 确保死信功能的自动配置

* 支持通过配置文件调整死信相关参数

## 4. 实现步骤

### 4.1 修改监听模式

1. 修改`RedisStreamMqStartServiceImpl.startSubscription`方法
2. 将`receiveAutoAck`改为`receive`手动ACK
3. 实现消息处理的重试机制

### 4.2 添加死信队列逻辑

1. 实现消息失败次数记录
2. 当重试次数达到阈值时，将消息移至死信队列
3. 死信队列使用独立的Stream

### 4.3 扩展注解

1. 扩展`RedisStreamMqListen`注解，添加重试和死信配置
2. 在`ListenAnnotation`中处理新的注解属性

### 4.4 添加死信消费者支持

1. 定义`DeadLetterStreamListener`接口
2. 支持通过注解声明死信队列监听
3. 确保死信队列的消息可以被正确消费

### 4.5 测试和验证

1. 编写测试用例
2. 验证死信功能的正确性
3. 确保与现有功能兼容

## 5. 技术要点

### 5.1 Redis Stream手动ACK

* 使用`XACK`命令确认消息

* 使用`XPENDING`命令管理未确认消息

* 使用`XCLAIM`命令处理超时消息

### 5.2 重试机制设计

* 基于Redis的Hash结构记录失败次数

* 失败次数达到阈值后移至死信队列

* 支持配置重试间隔

### 5.3 死信消息格式

* 包含原始消息内容

* 包含失败原因和重试次数

* 包含原始消息ID和时间戳

### 5.4 死信消费者实现

* 用户通过实现`DeadLetterStreamListener`接口来消费死信队列

* 使用与普通消费者相同的注解方式声明

* 支持独立配置死信队列的监听参数

## 6. 兼容性考虑

* 保持与现有代码的兼容性

* 现有注解无需修改即可继续使用

* 死信功能为可选功能，默认关闭

## 7. 预期效果

* 消息消费失败时自动重试

* 达到重试阈值后自动移至死信队列

* 用户可以通过实现`DeadLetterStreamListener`接口来消费死信队列

* 支持独立配置死信队列的监听参数

* 保持高性能和可靠性

